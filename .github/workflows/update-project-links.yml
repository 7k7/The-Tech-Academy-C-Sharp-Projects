name: Update Project Links
on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual runs

jobs:
  update-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate Project Links Markdown
        run: |
          echo "# C# Project Files" > ProjectLinks.md
          echo "" >> ProjectLinks.md
          # Use find command, excluding unwanted C# files
          find . -type f -name "*.cs" ! -name "AssemblyInfo.cs" ! -name "*AssemblyAttributes.cs" -print0 | while IFS= read -r -d '' file; do
            filepath=$(echo "$file" | sed 's|^\./||')  # Remove leading "./"
            filepath=$(echo "$filepath" | xargs)  # Trim any whitespace/newlines from filepath
            url_path=$(echo "$filepath" | jq -R -s -r @uri)  # Encode as a valid URL
            url_path=$(echo "$url_path" | sed 's/%0A$//')  # Remove trailing %0A if present
            echo "- [$filepath](https://github.com/7k7/The-Tech-Academy-C-Sharp-Projects/blob/main/$url_path)" >> ProjectLinks.md
          done

      - name: Commit and push changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add ProjectLinks.md
          git commit -m "Automated update of project links (fixed URL encoding issues)" || echo "No changes to commit"
          git push origin HEAD:main
